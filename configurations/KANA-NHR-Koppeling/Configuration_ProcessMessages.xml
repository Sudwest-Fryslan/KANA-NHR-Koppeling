<Module xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:noNamespaceSchemaLocation="../FrankConfig.xsd">
	<Adapter name="ProcessDDSMessageToKana">
		<Receiver>
			<ApiListener
				name="ProcessDDSMessageToKana"
				method="POST"
				uriPattern="/ProcessDDSMessageToKana/" />
		</Receiver>

		<Pipeline>
			<Exits>
				<Exit name="Success" state="SUCCESS" />
				<Exit name="Exception" state="ERROR" />
			</Exits>

			<!-- Router -->
			<XmlSwitchPipe name="CheckRequestElement"
				xpathExpression="local-name(//Body/*[1])">
				<Forward name="vesLv01" path="VesAddScope" />
				<Forward name="macLv01" path="RemoveWrongElement" />
			</XmlSwitchPipe>


			<!-- Add element -->
			<XsltPipe name="VesAddScope" indentXml="true"
				styleSheetName="xsl/VesAddScope.xsl" omitXmlDeclaration="true">
				<Forward name="success" path="SendMessage" />
			</XsltPipe>

			<XsltPipe name="RemoveWrongElement" indentXml="true"
				styleSheetName="xsl/MacRemoveIncorrectElement.xsl" omitXmlDeclaration="true" />

			<XsltPipe name="AddCorrectElement" indentXml="true"
				styleSheetName="xsl/MacAddNewElement.xsl" omitXmlDeclaration="true" />

			<XsltPipe name="MacAddScope" indentXml="true"
				styleSheetName="xsl/MacAddScope.xsl" omitXmlDeclaration="true">
				<Forward name="success" path="SendMessage" />
			</XsltPipe>


			<!-- Message sending -->
			<SenderPipe name="SendMessage">
				<WebServiceSender name="SendMessage" url="${target_endpoint}"
					throwApplicationFaults="false" methodType="POST"
					soap="false" />
				<Param name="soapAction"
					xpathExpression="concat('http://www.egem.nl/StUF/sector/bg/0310/', local-name(//Body/*[1]))"
					sessionKey="originalMessage" />
			</SenderPipe>

			<XmlIfPipe name="FaultCheck" xpathExpression="not(//faultcode)">
				<Forward name="then" path="Success" />
				<Forward name="else" path="Exception" />
			</XmlIfPipe>
		</Pipeline>
	</Adapter>

</Module>